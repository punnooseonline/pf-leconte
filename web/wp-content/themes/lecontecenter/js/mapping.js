// InfoBox JS
eval(function (p, a, c, k, e, r) { e = function (c) { return (c < a ? '' : e(parseInt(c / a))) + ((c = c % a) > 35 ? String.fromCharCode(c + 29) : c.toString(36)) }; if (!''.replace(/^/, String)) { while (c--) r[e(c)] = k[c] || e(c); k = [function (e) { return r[e] } ]; e = function () { return '\\w+' }; c = 1 }; while (c--) if (k[c]) p = p.replace(new RegExp('\\b' + e(c) + '\\b', 'g'), k[c]); return p } ('6 8(a){a=a||{};9.p.1O.2h(2,33);2.M=a.1s||"";2.1A=a.1n||G;2.Y=a.1F||0;2.E=a.1y||1e 9.p.1V(0,0);2.z=a.X||1e 9.p.2x(0,0);2.T=a.S||t;2.1k=a.1j||"2d";2.1i=a.D||{};2.1C=a.1B||"35";2.K=a.1g||"31://2W.9.2Q/2J/2I/2G/1v.2D";3(a.1g===""){2.K=""}2.17=a.1x||1e 9.p.1V(1,1);2.V=a.1o||G;2.16=a.1m||G;2.1J=a.2j||"2g";2.14=a.1q||G;2.4=t;2.w=t;2.P=t;2.O=t;2.B=t;2.N=t}8.q=1e 9.p.1O();8.q.24=6(){5 i;5 f;5 a;5 d=2;5 c=6(e){e.21=Z;3(e.15){e.15()}};5 b=6(e){e.2Z=G;3(e.1Y){e.1Y()}3(!d.14){c(e)}};3(!2.4){2.4=1f.2P("2M");2.1d();3(s 2.M.1r==="r"){2.4.L=2.F()+2.M}v{2.4.L=2.F();2.4.1a(2.M)}2.2C()[2.1J].1a(2.4);2.1z();3(2.4.7.C){2.N=Z}v{3(2.Y!==0&&2.4.W>2.Y){2.4.7.C=2.Y;2.4.7.2z="2w";2.N=Z}v{a=2.1N();2.4.7.C=(2.4.W-a.Q-a.13)+"12";2.N=G}}2.1p(2.1A);3(!2.14){2.B=[];f=["2p","1L","2o","2n","1K","2m","2l","2k","2i"];1l(i=0;i<f.1I;i++){2.B.1H(9.p.u.19(2.4,f[i],c))}2.B.1H(9.p.u.19(2.4,"1L",6(e){2.7.1G="2f"}))}2.O=9.p.u.19(2.4,"2e",b);9.p.u.R(2,"2c")}};8.q.F=6(){5 a="";3(2.K!==""){a="<2b";a+=" 2a=\'"+2.K+"\'";a+=" 29=13";a+=" 7=\'";a+=" X: 28;";a+=" 1G: 27;";a+=" 26: "+2.1C+";";a+="\'>"}J a};8.q.1z=6(){5 a;3(2.K!==""){a=2.4.3d;2.w=9.p.u.19(a,\'1K\',2.25())}v{2.w=t}};8.q.25=6(){5 a=2;J 6(e){e.21=Z;3(e.15){e.15()}9.p.u.R(a,"3c");a.1v()}};8.q.1p=6(d){5 m;5 n;5 e=0,H=0;3(!d){m=2.3a();3(m 39 9.p.38){3(!m.23().37(2.z)){m.36(2.z)}n=m.23();5 a=m.34();5 h=a.W;5 f=a.22;5 k=2.E.C;5 l=2.E.1h;5 g=2.4.W;5 b=2.4.22;5 i=2.17.C;5 j=2.17.1h;5 o=2.20().32(2.z);3(o.x<(-k+i)){e=o.x+k-i}v 3((o.x+g+k+i)>h){e=o.x+g+k+i-h}3(2.16){3(o.y<(-l+j+b)){H=o.y+l-j-b}v 3((o.y+l+j)>f){H=o.y+l+j-f}}v{3(o.y<(-l+j)){H=o.y+l-j}v 3((o.y+b+l+j)>f){H=o.y+b+l+j-f}}3(!(e===0&&H===0)){5 c=m.30();m.2Y(e,H)}}}};8.q.1d=6(){5 i,D;3(2.4){2.4.2X=2.1k;2.4.7.2V="";D=2.1i;1l(i 2U D){3(D.2R(i)){2.4.7[i]=D[i]}}3(s 2.4.7.18!=="r"&&2.4.7.18!==""){2.4.7.2O="2N(18="+(2.4.7.18*2L)+")"}2.4.7.X="2K";2.4.7.11=\'1u\';3(2.T!==t){2.4.7.S=2.T}}};8.q.1N=6(){5 c;5 a={1c:0,1b:0,Q:0,13:0};5 b=2.4;3(1f.1t&&1f.1t.1W){c=b.2H.1t.1W(b,"");3(c){a.1c=A(c.1U,10)||0;a.1b=A(c.1T,10)||0;a.Q=A(c.1X,10)||0;a.13=A(c.1S,10)||0}}v 3(1f.2F.I){3(b.I){a.1c=A(b.I.1U,10)||0;a.1b=A(b.I.1T,10)||0;a.Q=A(b.I.1X,10)||0;a.13=A(b.I.1S,10)||0}}J a};8.q.2E=6(){3(2.4){2.4.2S.2T(2.4);2.4=t}};8.q.1E=6(){2.24();5 a=2.20().2B(2.z);2.4.7.Q=(a.x+2.E.C)+"12";3(2.16){2.4.7.1b=-(a.y+2.E.1h)+"12"}v{2.4.7.1c=(a.y+2.E.1h)+"12"}3(2.V){2.4.7.11=\'1u\'}v{2.4.7.11="1R"}};8.q.2A=6(a){3(s a.1j!=="r"){2.1k=a.1j;2.1d()}3(s a.D!=="r"){2.1i=a.D;2.1d()}3(s a.1s!=="r"){2.1Q(a.1s)}3(s a.1n!=="r"){2.1A=a.1n}3(s a.1F!=="r"){2.Y=a.1F}3(s a.1y!=="r"){2.E=a.1y}3(s a.1m!=="r"){2.16=a.1m}3(s a.X!=="r"){2.1w(a.X)}3(s a.S!=="r"){2.1P(a.S)}3(s a.1B!=="r"){2.1C=a.1B}3(s a.1g!=="r"){2.K=a.1g}3(s a.1x!=="r"){2.17=a.1x}3(s a.1o!=="r"){2.V=a.1o}3(s a.1q!=="r"){2.14=a.1q}3(2.4){2.1E()}};8.q.1Q=6(a){2.M=a;3(2.4){3(2.w){9.p.u.U(2.w);2.w=t}3(!2.N){2.4.7.C=""}3(s a.1r==="r"){2.4.L=2.F()+a}v{2.4.L=2.F();2.4.1a(a)}3(!2.N){2.4.7.C=2.4.W+"12";3(s a.1r==="r"){2.4.L=2.F()+a}v{2.4.L=2.F();2.4.1a(a)}}2.1z()}9.p.u.R(2,"2y")};8.q.1w=6(a){2.z=a;3(2.4){2.1E()}9.p.u.R(2,"1Z")};8.q.1P=6(a){2.T=a;3(2.4){2.4.7.S=a}9.p.u.R(2,"2v")};8.q.2u=6(){J 2.M};8.q.1D=6(){J 2.z};8.q.2t=6(){J 2.T};8.q.2s=6(){2.V=G;3(2.4){2.4.7.11="1R"}};8.q.2r=6(){2.V=Z;3(2.4){2.4.7.11="1u"}};8.q.2q=6(c,b){5 a=2;3(b){2.z=b.1D();2.P=9.p.u.3b(b,"1Z",6(){a.1w(2.1D())})}2.1M(c);3(2.4){2.1p()}};8.q.1v=6(){5 i;3(2.w){9.p.u.U(2.w);2.w=t}3(2.B){1l(i=0;i<2.B.1I;i++){9.p.u.U(2.B[i])}2.B=t}3(2.P){9.p.u.U(2.P);2.P=t}3(2.O){9.p.u.U(2.O);2.O=t}2.1M(t)};', 62, 200, '||this|if|div_|var|function|style|InfoBox|google||||||||||||||||maps|prototype|undefined|typeof|null|event|else|closeListener_|||position_|parseInt|eventListeners_|width|boxStyle|pixelOffset_|getCloseBoxImg_|false|yOffset|currentStyle|return|closeBoxURL_|innerHTML|content_|fixedWidthSet_|contextListener_|moveListener_|left|trigger|zIndex|zIndex_|removeListener|isHidden_|offsetWidth|position|maxWidth_|true||visibility|px|right|enableEventPropagation_|stopPropagation|alignBottom_|infoBoxClearance_|opacity|addDomListener|appendChild|bottom|top|setBoxStyle_|new|document|closeBoxURL|height|boxStyle_|boxClass|boxClass_|for|alignBottom|disableAutoPan|isHidden|panBox_|enableEventPropagation|nodeType|content|defaultView|hidden|close|setPosition|infoBoxClearance|pixelOffset|addClickHandler_|disableAutoPan_|closeBoxMargin|closeBoxMargin_|getPosition|draw|maxWidth|cursor|push|length|pane_|click|mouseover|setMap|getBoxWidths_|OverlayView|setZIndex|setContent|visible|borderRightWidth|borderBottomWidth|borderTopWidth|Size|getComputedStyle|borderLeftWidth|preventDefault|position_changed|getProjection|cancelBubble|offsetHeight|getBounds|createInfoBoxDiv_|getCloseClickHandler_|margin|pointer|relative|align|src|img|domready|infoBox|contextmenu|default|floatPane|apply|touchmove|pane|touchend|touchstart|dblclick|mouseup|mouseout|mousedown|open|hide|show|getZIndex|getContent|zindex_changed|auto|LatLng|content_changed|overflow|setOptions|fromLatLngToDivPixel|getPanes|gif|onRemove|documentElement|mapfiles|ownerDocument|en_us|intl|absolute|100|div|alpha|filter|createElement|com|hasOwnProperty|parentNode|removeChild|in|cssText|www|className|panBy|returnValue|getCenter|http|fromLatLngToContainerPixel|arguments|getDiv|2px|setCenter|contains|Map|instanceof|getMap|addListener|closeclick|firstChild'.split('|'), 0, {}))

function omniClickMap(CLICKNAME, clicknamePrefix, EVENTS) {
    /*if ('undefined' !== typeof s_gi) {
        CLICKNAME = CLICKNAME.replace(/[^\w\s:]/gi, '');
        CLICKNAME = clicknamePrefix + ": " + CLICKNAME;
        s_objectID = CLICKNAME;
        var s = s_gi('usdmpfmainsite');
        s.linkTrackVars = 'eVar14,events,prop14,list1';
        s.linkTrackEvents = EVENTS;
        s.events = EVENTS;
        s.list1 = CLICKNAME;
        s.prop14 = 'customlinks: ' + CLICKNAME;
        s.eVar14 = CLICKNAME;
        s.tl(this, 'o', CLICKNAME);
    }*/
}


var map;
var mapData = [];
var panorama;
var markersArray = [];
var ib = new InfoBox();
var categoryIcons = {
    "Accommodation": valueObject.themeUrl+"/images/icon_where_to_stay.png",
    "Restaurant": valueObject.themeUrl+"/images/icon_where_to_eat.png",
    "Amusement": valueObject.themeUrl+"/images/icon_what_to_do.png",
    "Theater": valueObject.themeUrl+"/images/icon_theater.png",
    "TrolleyStop": valueObject.themeUrl+"/icon_trolley_stops.png",
    "Panorama": valueObject.themeUrl+"/images/icon_360.png",
    "Park": valueObject.themeUrl+"/images/icon_parks.png",
	"Special": valueObject.themeUrl+"/images/icon_special.png",
    "Tours": valueObject.themeUrl+"/images/icon_tours.png"
};


function DisplayInfoWindow(marker, content) {
    ib.close();

    var boxText = "<div class='gmap-infobox-content'>"+content+"</div><div class='gmap-marker-pointer'></div>";

    /* Omni Click Track: start */
    var contentID = jQuery(boxText).find("h2").attr("data-cat-name");
    var selectedCategory = jQuery("a.gmap-category.active").attr("data-cat-name");

    selectedCategory = ((typeof selectedCategory) == 'undefined') ? "LeConte" : selectedCategory;

    omniClickMap("show detail: " + selectedCategory + ": " + contentID, "map", "event81");
    /* Omni Click Track: end */

    

    ib = new InfoBox({
            content: boxText
            , disableAutoPan: false
            , maxWidth: 0
            , alignBottom: true
            , pixelOffset: new google.maps.Size(-98, -34)
            , zIndex: null
            , boxClass: "gmap-infobox"
            , closeBoxMargin: "15px 20px 2px 2px"
            , boxStyle: {
		          width: '290px',
                  height: '155px'
		        }
            , closeBoxURL: "http://www.google.com/intl/en_us/mapfiles/close.gif"
            , infoBoxClearance: new google.maps.Size(50, 50)
            , isHidden: false
            , pane: "floatPane"
            , enableEventPropagation: false
        });

        google.maps.event.addListener(ib, 'domready', function () {
            jQuery(".gmap-infobox a.more-info").click(function (e) {
                /* Omni Click Track: start */
                var contentID = jQuery(this).attr("data-cat-name");
                var selectedCategory = jQuery("a.gmap-category.active").attr("data-cat-name");
                omniClickMap("more info: " + selectedCategory + ": " + contentID, "map", "event82");
                /* Omni Click Track: end */
            });

            jQuery(".gmap-infobox a.coupon").click(function (e) {
                /* Omni Click Track: start */
                omniClickMap("content: " + jQuery(this).attr("href"), "map", "event82");
                /* Omni Click Track: end */
            });

            jQuery(".gmap-infobox a.launch360").click(function (e) {
                e.preventDefault();
                launch360(jQuery(this).attr('href'));
                return false;
            });
            google.maps.event.clearListeners(ib, 'domready');
        });

    ib.open(map, marker);
}
function toggleStreetView(lat, long) {
    if (panorama.getVisible() == false) {
        panorama.setPosition(new google.maps.LatLng(lat, long));
        panorama.setVisible(true);
    } else {
        panorama.setVisible(false);
    }
} 
function clearOverlays() {
    ib.close();
    if (markersArray) {
        for (var i = 0; i < markersArray.length; i++ ) {
                markersArray[i].setMap(null);
        }
    }
}
function SelectOnCategory(category, subcategories)
{
    var categoryArray = [];
    jQuery.each(mapData, function (key, mapItem) {
        if (mapItem.SubCategory.indexOf(';') == -1) {
            if (jQuery.inArray(mapItem.SubCategory, subcategories) >= 0) {
                categoryArray.push(mapItem);
            }
        }
        else {
            jQuery.each(mapItem.SubCategory.split(';'), function (key2, subcat) {
                if (jQuery.inArray(subcat, subcategories) >= 0) {
                    categoryArray.push(mapItem);
                }
            });
        }
    });
    return categoryArray;
}
function DisplayMarkersByCategory(category) {
	jQuery.getJSON( "http://pf.usdmdev.net/ws/Map.asmx/GetCategoryJson?categoryStr=" + category, 
        function( data ) {
            DisplayMarkersFromJson(data);
        });
}
function DisplayMarkersFromJson(dataToMark) {
    clearOverlays();

    jQuery.each(dataToMark, function (key, val) {
    	addMarkerToMap(val.MarkerTitle, val.Latitude, val.Longitude, val.Category, val.InfoWindowHTML);
    });
}
function addMarkerToMap(title, latitude, longitude, category, infoWindowHTML) {
	var marker = new google.maps.Marker({
		position: new google.maps.LatLng(latitude, longitude),
		title: title,
		map: map,
		icon: categoryIcons[category]
	});
	markersArray.push(marker);
	google.maps.event.addListener(marker, 'click', function () {
		DisplayInfoWindow(this, infoWindowHTML);
	});

	return marker;
}
function launch360(url) {
    jQuery("#map_canvas").hide();
    jQuery("#frame").prepend("<div class='frame-360'><a onclick='close360();' class='frame-360-close'>close</a><iframe src='" + url + "' scrolling='no' height='632px' width='724px'></iframe></div>");
}
function close360() {
    jQuery("#map_canvas").show();
    jQuery("#frame .frame-360").remove();
}
jQuery(document).ready(function () {
    var canvas = document.getElementById("map_canvas");
    if (canvas) {
        try { console.log("start loading map"); } catch (e) { }
        var latlng = new google.maps.LatLng(35.80876483122123, -83.56175422668457);
        var myOptions = {
            zoom: 14,
            center: latlng,
            mapTypeId: google.maps.MapTypeId.HYBRID, //ROADMAP
            streetViewControl: false
        };
        map = new google.maps.Map(canvas, myOptions);

        jQuery('.map-loading')
            .hide()  // hide it initially
            .ajaxStart(function () {
                jQuery(this).show();
            })
            .ajaxStop(function () {
                jQuery(this).hide();
            });

        // We get the map's default panorama and set up some defaults.
        // Note that we don't yet set it visible.
        panorama = map.getStreetView();
        panorama.setPov({
            heading: 265,
            zoom: 1,
            pitch: 0
        });

        jQuery('#introCopy a').click(function () {
            /* Omni Click Track: start */
            var selectedCategory = jQuery(this).attr("data-cat-name");
            omniClickMap("content: " + jQuery(this).attr("href"), "map", "event5");
            /* Omni Click Track: end */
        });

        jQuery('.gmap-subcategory').prepend("<li><input type='checkbox' checked='checked' value='all' /> Show All</li>");

        jQuery('#sideNavigation a').click(function () {
            jQuery('#sideNavigation a.active').parent().children('ul').slideUp('fast');
            jQuery('#sideNavigation a').not(this).removeClass('active').removeClass('activesub');
            jQuery(this).addClass('active');
            if (jQuery(this).parent().children('ul').length > 0) {
                jQuery(this).addClass('activesub');
                jQuery(this).parent().children('ul').slideDown('fast');
            }
        });

        jQuery('.gmap-category.json').click(function (event) {
            event.preventDefault();

            /* Omni Click Track: start */
            var selectedCategory = jQuery(this).attr("data-cat-name");
            omniClickMap("map it: " + selectedCategory, "map", "event80");
            /* Omni Click Track: end */

            var subCats = [];
            jQuery(this).next(".gmap-subcategory").children('input[type="checkbox"] :checked').each(function () {
                subCats.push(jQuery(this).val());
            });

            DisplayMarkersByCategory(selectedCategory);
        });

        //    jQuery('.gmap-subcategory input[type="checkbox"]').click(function (event) {
        //        var subCats = [];
        //        jQuery(this).parent().siblings().andSelf().find('input[type="checkbox"]:checked').each(function () {
        //            subCats.push(jQuery(this).val());
        //        });
        //        DisplayMarkersFromJson(SelectOnCategory(jQuery(this).parents().eq(2).children(".gmap-category").attr("data-cat-name"), subCats));
        //    });

        jQuery('.gmap-subcategory input[type="checkbox"]').on("click", gmapSubcategoryClick);

        google.maps.event.addListenerOnce(map, 'idle', function() {
            addLeConteCenterToMap();
            map.panTo(marker.getPosition());
        });
        jQuery(document).ajaxSuccess(function(e) {
            addLeConteCenterToMap();
        });    
    }
});

function gmapSubcategoryClick(event) {
    var subCats = [];
    var optionElements = jQuery(this).parent().siblings().andSelf().find('input[type="checkbox"]');

    if (jQuery(this).is(':checked')) {
        /* Omni Click Track: start */
        var selectedCategory = jQuery(this).parents().eq(2).children("a.gmap-category").attr("data-cat-name");
        var selectedSubCategory = jQuery(this).val();
        omniClickMap("map it: " + selectedCategory + ": " + selectedSubCategory, "map", "event80");
        /* Omni Click Track: end */
    }

    // Handle state of show all
    if (jQuery(this).val() == 'all' && jQuery(this).is(':checked')) {
        optionElements.not("input[value='all']").off("click").attr("checked", "checked").on("click", gmapSubcategoryClick);
    }
    else if (jQuery(this).val() == 'all' && !jQuery(this).is(':checked')) {
        optionElements.not("input[value='all']").off("click").removeAttr("checked").on("click", gmapSubcategoryClick);
    }
    else {
        optionElements.filter("input[value='all']").off("click").removeAttr("checked").on("click", gmapSubcategoryClick);
    }

    // check to see if all is selected
    if (optionElements.is("input[value='all']:checked")) {
        optionElements.not("input[value='all']").each(function () {
            subCats.push(jQuery(this).val());
        });
    }
    else {
        optionElements.filter(':checked').each(function () { //.find('input[type="checkbox"]:checked')
            subCats.push(jQuery(this).val());
        });
    }

    DisplayMarkersFromJson(SelectOnCategory(jQuery(this).parents().eq(2).children(".gmap-category").attr("data-cat-name"), subCats));
}

function addLeConteCenterToMap() {
    marker = addMarkerToMap('LeConte Center', 35.797144, -83.561159, 'Special', '<h2 data-cat-name="1423">LeConte Center</h2><div>P.O. box 1390, Pigeon Forge, TN 37862.</div>');
    
}
/* Mapping by device http://stackoverflow.com/a/18899718 */
function directionsByDevice() {
    // If it's an iPhone..
    if ((navigator.platform.indexOf("iPhone") != -1) || (navigator.platform.indexOf("iPod") != -1) || (navigator.platform.indexOf("iPad") != -1))
        window.open("http://maps.apple.com/?daddr=LeConte+Center+at+Pigeon+Forge,+2986+Teaster+Ln,+Pigeon+Forge,+TN+37863");
    else
        window.open("http://maps.google.com/maps/?daddr=LeConte+Center+at+Pigeon+Forge,+2986+Teaster+Ln,+Pigeon+Forge,+TN+37863");
}